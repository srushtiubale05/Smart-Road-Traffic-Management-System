<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Violations Management - Traffic System</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <style>
      body {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      }
      .container-fluid {
        padding: 2rem;
      }
      .card {
        border-radius: 15px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        margin-bottom: 2rem;
        border: none;
      }
      .card-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 15px 15px 0 0 !important;
        padding: 1.5rem;
      }
      .violation-item {
        border-left: 4px solid #dc3545;
        padding: 1rem;
        margin-bottom: 1rem;
        background: #f8f9fa;
        border-radius: 8px;
        transition: all 0.3s;
      }
      .violation-item:hover {
        transform: translateX(5px);
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
      }
      .violation-item.paid {
        border-left-color: #28a745;
        opacity: 0.7;
      }
      .btn-pay {
        background: linear-gradient(135deg, #28a745, #20c997);
        border: none;
        color: white;
      }
      .btn-pay:hover {
        transform: scale(1.05);
      }
      .stats-card {
        background: white;
        border-radius: 10px;
        padding: 1.5rem;
        text-align: center;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
      }
      .stats-card h3 {
        color: #667eea;
        font-size: 2.5rem;
        margin: 0;
      }
      .stats-card p {
        color: #6c757d;
        margin: 0.5rem 0 0;
      }
      .plate-image {
        max-width: 200px;
        border-radius: 8px;
        box-shadow: 0 3px 10px rgba(0, 0, 0, 0.2);
      }
      .search-box {
        background: white;
        border-radius: 10px;
        padding: 1.5rem;
        margin-bottom: 2rem;
      }
    </style>
  </head>
  <body>
    <div class="container-fluid">
      <!-- Header -->
      <div class="row mb-4">
        <div class="col-12">
          <div class="card">
            <div class="card-body text-center">
              <h1><i class="fas fa-gavel"></i> Violations Management</h1>
              <p class="mb-0">Monitor and manage traffic violations</p>
            </div>
          </div>
        </div>
      </div>

      <!-- Statistics -->
      <div class="row mb-4">
        <div class="col-md-4">
          <div class="stats-card">
            <h3 id="totalViolations">0</h3>
            <p>Total Violations</p>
          </div>
        </div>
        <div class="col-md-4">
          <div class="stats-card">
            <h3 id="pendingViolations">0</h3>
            <p>Pending Fines</p>
          </div>
        </div>
        <div class="col-md-4">
          <div class="stats-card">
            <h3 id="totalAmount">â‚¹0</h3>
            <p>Total Amount</p>
          </div>
        </div>
      </div>

      <!-- Search Box -->
      <div class="search-box">
        <div class="row">
          <div class="col-md-8">
            <input
              type="text"
              id="searchInput"
              class="form-control"
              placeholder="ðŸ” Search by Plate Number or Owner Name..."
            />
          </div>
          <div class="col-md-4">
            <button class="btn btn-primary w-100" onclick="searchVehicle()">
              <i class="fas fa-search"></i> Search
            </button>
          </div>
        </div>
        <div id="searchResults" class="mt-3"></div>
      </div>

      <!-- Violations List -->
      <div class="card">
        <div class="card-header">
          <h4 class="mb-0"><i class="fas fa-list"></i> All Violations</h4>
          <small>Click to view details and manage</small>
        </div>
        <div class="card-body">
          <div class="form-check mb-3">
            <input
              class="form-check-input"
              type="checkbox"
              id="showPendingOnly"
              checked
              onchange="loadViolations()"
            />
            <label class="form-check-label" for="showPendingOnly">
              Show Pending Only
            </label>
          </div>
          <div id="violationsList">
            <div class="text-center">
              <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Violation Detail Modal -->
    <div class="modal fade" id="violationModal" tabindex="-1">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header bg-danger text-white">
            <h5 class="modal-title">
              <i class="fas fa-exclamation-triangle"></i> Violation Details
            </h5>
            <button
              type="button"
              class="btn-close btn-close-white"
              data-bs-dismiss="modal"
            ></button>
          </div>
          <div class="modal-body" id="modalBody">
            <!-- Content loaded dynamically -->
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      let allViolations = [];

      // Load violations on page load
      document.addEventListener("DOMContentLoaded", function () {
        loadViolations();
      });

      async function loadViolations() {
        try {
          const response = await fetch("/api/violations/pending");
          const data = await response.json();

          if (data.success) {
            allViolations = data.violations;
            displayViolations(allViolations);
            updateStats(allViolations);
          } else {
            alert("Error loading violations");
          }
        } catch (error) {
          console.error("Error:", error);
          document.getElementById("violationsList").innerHTML =
            '<p class="text-danger">Error loading violations</p>';
        }
      }

      function displayViolations(violations) {
        const showPendingOnly =
          document.getElementById("showPendingOnly").checked;
        const filtered = showPendingOnly
          ? violations.filter((v) => v.status === "pending")
          : violations;

        if (filtered.length === 0) {
          document.getElementById("violationsList").innerHTML =
            '<p class="text-muted">No violations found</p>';
          return;
        }

        const html = filtered
          .map(
            (v) => `
                <div class="violation-item ${
                  v.status
                }" onclick="showViolationDetails(${v.id})">
                    <div class="row align-items-center">
                        <div class="col-md-2">
                            ${
                              v.plate_image_path
                                ? `<img src="${v.plate_image_path}" class="plate-image" alt="Plate">`
                                : '<div class="text-muted">No Image</div>'
                            }
                        </div>
                        <div class="col-md-4">
                            <h5>${v.detected_text || v.plate_number}</h5>
                            <p class="mb-0">
                                <strong>Owner:</strong> ${
                                  v.owner_name || "Unknown"
                                }<br>
                                <strong>Vehicle:</strong> ${
                                  v.vehicle_model || "N/A"
                                }
                            </p>
                        </div>
                        <div class="col-md-3">
                            <p class="mb-0">
                                <i class="fas fa-calendar"></i> ${new Date(
                                  v.violation_date
                                ).toLocaleString()}<br>
                                <i class="fas fa-map-marker-alt"></i> ${
                                  v.location
                                }
                            </p>
                        </div>
                        <div class="col-md-3 text-end">
                            <h4 class="text-danger mb-2">â‚¹${v.fine_amount}</h4>
                            ${
                              v.status === "pending"
                                ? `<button class="btn btn-pay btn-sm" onclick="event.stopPropagation(); markAsPaid(${v.id})">
                                    <i class="fas fa-check"></i> Mark Paid
                                </button>`
                                : '<span class="badge bg-success">Paid</span>'
                            }
                        </div>
                    </div>
                </div>
            `
          )
          .join("");

        document.getElementById("violationsList").innerHTML = html;
      }

      function updateStats(violations) {
        const pending = violations.filter((v) => v.status === "pending");
        const totalAmount = pending.reduce(
          (sum, v) => sum + parseFloat(v.fine_amount),
          0
        );

        document.getElementById("totalViolations").textContent =
          violations.length;
        document.getElementById("pendingViolations").textContent =
          pending.length;
        document.getElementById("totalAmount").textContent =
          "â‚¹" + totalAmount.toFixed(2);
      }

      async function showViolationDetails(id) {
        const violation = allViolations.find((v) => v.id === id);
        if (!violation) return;

        const modalBody = document.getElementById("modalBody");
        modalBody.innerHTML = `
                <div class="row">
                    <div class="col-md-6">
                        <h6>Plate Information</h6>
                        <p><strong>Detected:</strong> ${
                          violation.detected_text || "N/A"
                        }</p>
                        <p><strong>Confidence:</strong> ${(
                          violation.confidence * 100
                        ).toFixed(2)}%</p>
                        ${
                          violation.plate_image_path
                            ? `<img src="${violation.plate_image_path}" class="img-fluid rounded" alt="Plate">`
                            : ""
                        }
                    </div>
                    <div class="col-md-6">
                        <h6>Owner Information</h6>
                        <p><strong>Name:</strong> ${
                          violation.owner_name || "Unknown"
                        }</p>
                        <p><strong>Phone:</strong> ${
                          violation.owner_phone || "N/A"
                        }</p>
                        <p><strong>Vehicle:</strong> ${
                          violation.vehicle_model || "N/A"
                        }</p>
                    </div>
                </div>
                <hr>
                <div class="row">
                    <div class="col-12">
                        <h6>Violation Details</h6>
                        <p><strong>Type:</strong> ${
                          violation.violation_type
                        }</p>
                        <p><strong>Date:</strong> ${new Date(
                          violation.violation_date
                        ).toLocaleString()}</p>
                        <p><strong>Location:</strong> ${violation.location}</p>
                        <p><strong>Fine:</strong> â‚¹${violation.fine_amount}</p>
                        <p><strong>Status:</strong> <span class="badge bg-${
                          violation.status === "pending" ? "warning" : "success"
                        }">${violation.status}</span></p>
                    </div>
                </div>
                ${
                  violation.image_path
                    ? `
                    <hr>
                    <div class="text-center">
                        <img src="${violation.image_path}" class="img-fluid rounded" alt="Violation">
                    </div>
                `
                    : ""
                }
            `;

        new bootstrap.Modal(document.getElementById("violationModal")).show();
      }

      async function markAsPaid(id) {
        if (!confirm("Mark this violation as paid?")) return;

        try {
          const response = await fetch(`/api/violations/update/${id}`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ status: "paid" }),
          });

          const data = await response.json();
          if (data.success) {
            alert("Violation marked as paid");
            loadViolations();
          } else {
            alert("Error updating violation");
          }
        } catch (error) {
          console.error("Error:", error);
          alert("Error updating violation");
        }
      }

      async function searchVehicle() {
        const searchTerm = document.getElementById("searchInput").value.trim();
        if (!searchTerm) {
          alert("Please enter a search term");
          return;
        }

        try {
          const response = await fetch("/api/vehicles/search", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ search_term: searchTerm }),
          });

          const data = await response.json();
          const resultsDiv = document.getElementById("searchResults");

          if (data.success && data.results.length > 0) {
            const html = data.results
              .map(
                (r) => `
                        <div class="alert alert-info" role="alert">
                            <strong>${r.plate_number}</strong> - ${r.owner_name}<br>
                            ${r.vehicle_model} | Phone: ${r.phone}
                            <button class="btn btn-sm btn-primary float-end" onclick="loadViolationsForPlate('${r.plate_number}')">
                                View Violations
                            </button>
                        </div>
                    `
              )
              .join("");
            resultsDiv.innerHTML = html;
          } else {
            resultsDiv.innerHTML = '<p class="text-muted">No results found</p>';
          }
        } catch (error) {
          console.error("Error:", error);
        }
      }

      async function loadViolationsForPlate(plateNumber) {
        try {
          const response = await fetch(`/api/violations/plate/${plateNumber}`);
          const data = await response.json();

          if (data.success) {
            displayViolations(data.violations);
            updateStats(data.violations);
          }
        } catch (error) {
          console.error("Error:", error);
        }
      }
    </script>
  </body>
</html>
